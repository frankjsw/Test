name: Weirdhost è‡ªåŠ¨å”¤é†’

on:
  workflow_dispatch:        # æ‰‹åŠ¨è§¦å‘
  repository_dispatch:      # ç”± Uptime Kuma ç­‰å¤–éƒ¨äº‹ä»¶è§¦å‘
    types: [service-down-alert]
  schedule:
    - cron: '0 0 */3 * *'   # æ¯ä¸‰å¤©æ‰§è¡Œä¸€æ¬¡ (UTC æ—¶é—´)

jobs:
  wakeup:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§¾ æ£€æŸ¥è§¦å‘äº‹ä»¶
        run: |
          echo "Workflow triggered by: ${{ github.event_name }}"
          if [[ "${{ github.event_name }}" == "repository_dispatch" ]]; then
            echo "è§¦å‘äº‹ä»¶ç±»å‹ (Event Type): ${{ github.event.action }}"
            echo "æ”¶åˆ°æ¥è‡ª Uptime Kuma çš„ä¸‹çº¿é€šçŸ¥ï¼Œå¼€å§‹æ‰§è¡Œè‡ªåŠ¨å”¤é†’æµç¨‹..."
          elif [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "å·¥ä½œæµè¢«æ‰‹åŠ¨è§¦å‘ï¼Œå¼€å§‹æ‰§è¡Œå”¤é†’..."
          else
            echo "å·¥ä½œæµç”±è®¡åˆ’ä»»åŠ¡è§¦å‘ï¼Œå¼€å§‹æ‰§è¡Œå”¤é†’..."
          fi

      - name: ğŸ“¦ æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ§° å®‰è£… Chromium
        uses: browser-actions/setup-chromium@v2

      - name: ğŸ è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ å®‰è£… Python ä¾èµ–
        working-directory: ${{ github.workspace }}
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          ls -al
          python -m pip install --upgrade pip
          pip install -r keep/requirements.txt
          
      - name: ğŸ§­ è°ƒè¯•ç›®å½•ç»“æ„
        run: |
          echo "å½“å‰è·¯å¾„ï¼š$(pwd)"
          echo "=== åˆ—å‡ºä»“åº“æ‰€æœ‰æ–‡ä»¶ ==="
          find . -maxdepth 3 -type f
          
      - name: ğŸš€ æ‰§è¡Œ Weirdhost å”¤é†’è„šæœ¬
        working-directory: ${{ github.workspace }}
        env:
          WEIRDHOST_APP_URL: ${{ secrets.WEIRDHOST_APP_URL }}
        run: |
          echo "å½“å‰å·¥ä½œç›®å½•ï¼š$(pwd)"
          echo "åˆ—å‡º keep ç›®å½•å†…å®¹ï¼š"
          ls -al keep || echo "âš ï¸ keep ç›®å½•ä¸å­˜åœ¨ï¼"
          
          echo "å¼€å§‹æ‰§è¡Œå”¤é†’è„šæœ¬..."
          python keep/weirdhost-keep.py
